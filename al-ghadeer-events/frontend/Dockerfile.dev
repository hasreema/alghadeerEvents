# Development Dockerfile for Next.js with hot-reload

FROM node:18-alpine

WORKDIR /app

# Fix SSL issues for Alpine package manager
RUN echo "http://dl-cdn.alpinelinux.org/alpine/v3.18/main" > /etc/apk/repositories && \
    echo "http://dl-cdn.alpinelinux.org/alpine/v3.18/community" >> /etc/apk/repositories

# Install dependencies for native modules
RUN apk update && \
    apk add --no-cache libc6-compat python3 make g++ ca-certificates openssl && \
    update-ca-certificates || true

# Copy package files
COPY package*.json ./

# Configure npm to handle SSL issues
RUN npm config set strict-ssl false && \
    npm config set registry http://registry.npmjs.org/ && \
    npm set maxsockets 1

# Install dependencies with multiple fallback options
RUN npm install --verbose --no-audit --no-fund || \
    npm install --legacy-peer-deps --verbose --no-audit --no-fund || \
    npm install --force --verbose --no-audit --no-fund || \
    echo "npm install failed, but continuing..."

# Expose port
EXPOSE 3000

# Run development server
CMD ["npm", "run", "dev"]